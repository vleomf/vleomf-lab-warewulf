require 'yaml'
cwd = File.dirname(File.expand_path(__FILE__))
yml = YAML.load_file("#{cwd}/boxes.yaml")
cfg = yml['nodes']

Vagrant.configure("2") do |config|
    cfg.each do | c | 
        config.vm.define "#{c['name']}" do |vmdef|
            vmdef.vbguest.auto_update = false if Vagrant.has_plugin?('vagrant-vbguest')
            # vmdef.vm.box = "ubuntu/trusty64"
            # vmdef.vm.box_version = "20191107.0.0"
            vmdef.vm.box = "#{c['box']}" #"almalinux/9"
            vmdef.vm.box_version = "#{c['box_version']}" #"9.4.20240805"
            vmdef.vm.hostname =  "#{c['name']}".gsub(/\_/, '-')
            vmdef.vm.network "private_network", ip: "#{c['ip']}", name: "#{c['host_only_adapter']}", adapter: 2

            vmdef.vm.provision "ansible" do |ansible|
                ansible.compatibility_mode = "2.0"
                ansible.extra_vars = {
                    ansible_user: "vagrant"
                }
                ansible.playbook = "src/#{c['name']}/playbook.yml"
            end
            
            # Sadly, WSL2 does not support other path than "."
            # so we ended rsyncing the whole project
            vmdef.vm.synced_folder ".", '/vagrant', type: "rsync"
            vmdef.vm.provider "virtualbox" do |vb|
                vb.check_guest_additions = false
            end
            
            # Using bindfs pluging, we can bind directories in vm paths.
            c['bind_folders'].each do |bf|
                vmdef.bindfs.bind_folder "/vagrant/src/#{c['name']}/#{bf['name']}", "#{bf['path']}",
                u: "vagrant",
                g: "vagrant",
                p: "0774",
                chown_ignore: true,
                chgrp_ignore: true,
                chmod_ignore: true
            end
        end
    end
end